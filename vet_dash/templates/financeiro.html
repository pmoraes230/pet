{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="bg-gray-50 flex h-screen overflow-hidden">
    <!-- Sidebar do Veterinário -->
    {% include "partials/aside/aside_vet.html" %}

    <main class="flex-1 flex flex-col overflow-hidden">
        <!-- Header fixo -->
        {% include "partials/header/header_vet.html" %}

        <div class="flex-1 p-6 md:p-10 overflow-y-auto">
            <h2 class="text-3xl font-black text-gray-800 mb-8 tracking-tight">Painel Financeiro</h2>

            <!-- Cards de Resumo -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-10">
                <div class="bg-white p-8 rounded-[35px] shadow-sm border border-gray-100">
                    <p class="text-gray-400 font-bold text-sm mb-2 uppercase tracking-widest">Entrada (Mês)</p>
                    <h3 class="text-3xl font-black text-gray-800">R$ {{ entradas_mes|floatformat:2 }}</h3>
                </div>
                <div class="bg-white p-8 rounded-[35px] shadow-sm border border-gray-100">
                    <p class="text-gray-400 font-bold text-sm mb-2 uppercase tracking-widest">Saídas (Mês)</p>
                    <h3 class="text-3xl font-black text-gray-800">R$ {{ saidas_mes|floatformat:2 }}</h3>
                </div>
                <div class="bg-white p-8 rounded-[35px] shadow-sm border border-gray-100">
                    <p class="text-gray-400 font-bold text-sm mb-2 uppercase tracking-widest">Saldo Líquido</p>
                    <h3 class="text-3xl font-black text-[#26C2B9]">R$ {{ saldo_liquido|floatformat:2 }}</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                <!-- Gráfico Principal -->
                <div class="lg:col-span-2 bg-white p-10 rounded-[40px] shadow-sm border border-gray-100">
                    <h3 class="text-2xl font-black text-gray-800 mb-8">Fluxo de Caixa Semestral</h3>
                    <div class="h-[400px]">
                        <canvas id="financeChart"></canvas>
                    </div>
                </div>

                <!-- Transações Recentes -->
                <div class="bg-white p-10 rounded-[40px] shadow-sm border border-gray-100 flex flex-col">
                    <h3 class="text-2xl font-black text-gray-800 mb-8">Transações Recentes</h3>
                    <div class="space-y-8 overflow-y-auto pr-2">
                        {% for t in transacoes %}
                        <div class="flex justify-between items-center group">
                            <div>
                                <!-- CORRIGIDO: id_pet para pet -->
                                <p class="font-black text-gray-800 text-sm group-hover:text-[#26C2B9] transition-colors">
                                    Pagamento Consulta - {{ t.pet.nome }}
                                </p>
                                <p class="text-xs text-gray-400 font-bold">
                                    {{ t.data_consulta|date:"d/m" }} às {{ t.horario_consulta|time:"H:i" }}
                                </p>
                            </div>
                            <span class="text-[#26C2B9] font-black text-lg">+ R$ {{ t.valor_consulta|floatformat:2 }}</span>
                        </div>
                        {% empty %}
                        <div class="text-center py-20 text-gray-400">
                            <i data-lucide="banknote" class="mx-auto mb-4 opacity-20" size="48"></i>
                            <p class="italic font-bold">Nenhuma transação registrada.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Script do Gráfico -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('financeChart').getContext('2d');
    
    // Pegando os dados vindos da view via JSON
    const labels = {{ labels_json|safe }};
    const dataValues = {{ valores_json|safe }};

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Receita',
                    data: dataValues,
                    backgroundColor: '#26C2B9',
                    borderRadius: 20,
                    borderSkipped: false,
                    barThickness: 35,
                },
                {
                    label: 'Tendência',
                    data: dataValues,
                    type: 'line',
                    borderColor: '#FFA500',
                    borderWidth: 4,
                    pointRadius: 0,
                    tension: 0.4,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#1f2937',
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    padding: 12,
                    displayColors: false,
                    callbacks: {
                        label: function(context) {
                            return 'R$ ' + context.parsed.y.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                        }
                    }
                }
            },
            scales: {
                x: { 
                    grid: { display: false }, 
                    border: { display: false },
                    ticks: { font: { weight: 'bold' }, color: '#9ca3af' }
                },
                y: { 
                    beginAtZero: true, 
                    grid: { color: '#f3f4f6', drawTicks: false },
                    border: { display: false },
                    ticks: { 
                        font: { weight: 'bold' }, 
                        color: '#9ca3af',
                        callback: function(value) { return 'R$ ' + value; }
                    }
                }
            }
        }
    });

    lucide.createIcons();
</script>
{% endblock %}