{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="bg-gray-50 flex flex-col md:flex-row h-screen overflow-hidden">

    {% include "partials/aside/aside_tutor.html" %}

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">

        {% include "partials/header/header_tutor.html" %}

        <div class="flex-1 flex overflow-hidden p-4 md:p-6 gap-4 z-10">

            <!-- Lista de veterinários (contatos) -->
            <div class="w-full md:w-80 bg-white rounded-[2.5rem] shadow-sm border border-gray-100 flex flex-col overflow-hidden">
                <div class="p-6">
                    <h3 class="text-xl font-black text-gray-800 tracking-tight">Conversas</h3>
                </div>
                <div class="flex-1 overflow-y-auto px-4 pb-4 space-y-3" id="contatos-list">
                    {% for contato in contatos %}
                    <a href="?vet_id={{ contato.id }}"
                       class="flex items-center gap-3 p-3 rounded-[2rem] transition-all group border
                       {% if vet_selecionado and contato.id == vet_selecionado.id %} bg-purple-50 border-purple-100 {% else %} border-transparent hover:bg-gray-50 {% endif %}">
                        
                        <div class="w-14 h-14 rounded-full overflow-hidden border-2 border-white shadow-sm flex-shrink-0">
                            {% if contato.imagem_perfil_veterinario %}
                            <img src="{{ contato.imagem_perfil_veterinario.url }}" class="w-full h-full object-cover">
                            {% else %}
                            <div class="w-full h-full bg-purple-100 flex items-center justify-center text-purple-400">
                                <i data-lucide="user" width="24"></i>
                            </div>
                            {% endif %}
                        </div>

                        <div class="flex-1 min-w-0">
                            <div class="bg-white px-4 py-2 rounded-full border border-gray-100 shadow-sm inline-block max-w-full">
                                <p class="text-sm font-bold text-gray-800 truncate">Dr(a). {{ contato.nome }}</p>
                            </div>
                        </div>
                    </a>
                    {% empty %}
                    <p class="text-center text-gray-400 text-sm mt-10">Nenhum veterinário disponível.</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Área do chat (atualizada via AJAX) -->
            <div id="chat-area" class="hidden md:flex flex-1 bg-white/40 backdrop-blur-md rounded-[2.5rem] shadow-sm border border-white/60 flex-col overflow-hidden relative">
                {% include "partials/chat_box_tutor.html" %}
            </div>

        </div>

        <!-- Footer decorativo (opcional) -->
        <div class="absolute bottom-0 left-0 w-full overflow-hidden leading-none rotate-180 text-brand-teal pointer-events-none z-0 opacity-40">
            <svg class="relative block w-[calc(100%+1.3px)] h-[60px] text-purple-100" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120" preserveAspectRatio="none">
                <path d="M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z" fill="currentColor"></path>
            </svg>
        </div>

    </main>
</div>

<script>
// Variáveis globais
const loggedUserId = "{% if request.session.user_id %}{{ request.session.user_id|escapejs }}{% else %}null{% endif %}";
let currentVetId = "{{ vet_selecionado.id|default:'' }}";
let socket = null;

lucide.createIcons();

// Helpers
function getChatBox() {
    return document.getElementById('chat-box');
}

function scrollToBottom() {
    const box = getChatBox();
    if (box) {
        box.scrollTop = box.scrollHeight;
    }
}

// Conexão WebSocket
function connectWebSocket(vetId) {
    if (!vetId) return;

    // Fecha conexão anterior se existir
    if (socket) {
        socket.close();
        socket = null;
    }

    const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const wsUrl = `${protocol}://${window.location.host}/ws/chat/${vetId}/`;

    socket = new WebSocket(wsUrl);

    socket.onopen = () => {
        console.log(`WebSocket conectado para vet`);
    };

    socket.onmessage = (e) => {
        console.log("Mensagem recebida via WS");
        const data = JSON.parse(e.data);
        const isMe = String(data.sender_id) === String(loggedUserId);

        const msgDiv = document.createElement('div');
        msgDiv.className = isMe
            ? 'flex flex-col items-end ml-auto max-w-[70%] group'
            : 'flex flex-col items-start max-w-[70%] group';

        msgDiv.innerHTML = `
            <div class="${isMe 
                ? 'bg-purple-600 text-white p-5 rounded-t-[2rem] rounded-bl-[2rem] shadow-lg shadow-purple-200/50' 
                : 'bg-white text-gray-700 p-5 rounded-t-[2rem] rounded-br-[2rem] shadow-sm border border-gray-100'
            } text-sm font-medium leading-relaxed">
                ${data.mensagem.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
            </div>
            <span class="text-[10px] font-black text-gray-400 mt-2 ${isMe ? 'mr-2' : 'ml-2'} uppercase tracking-widest">
                ${data.data_envio}
            </span>
        `;

        const box = getChatBox();
        if (box) {
            box.appendChild(msgDiv);
            scrollToBottom();
        }
    };

    socket.onclose = (e) => console.log(`WebSocket fechado: código ${e.code}`);
    socket.onerror = (err) => console.error("Erro no WebSocket:", err);
}

// Carregar chat via AJAX
async function loadChat(vetId) {
    try {
        const response = await fetch(`?vet_id=${vetId}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        if (!response.ok) {
            console.error("Erro na requisição AJAX:", response.status);
            return;
        }

        const html = await response.text();
        document.getElementById('chat-area').innerHTML = html;

        lucide.createIcons();
        scrollToBottom();

        // Re-anexa evento de submit no novo form
        const form = document.querySelector('#chat-area form');
        if (form) {
            form.removeEventListener('submit', handleFormSubmit);
            form.addEventListener('submit', handleFormSubmit);
        }

        // Reconecta WebSocket
        connectWebSocket(vetId);
    } catch (err) {
        console.error("Falha ao carregar chat:", err);
    }
}

// Intercepta envio do form → envia via WebSocket
function handleFormSubmit(e) {
    e.preventDefault();
    const input = e.target.querySelector('input[name="mensagem"]');
    const mensagem = input?.value.trim();

    if (!mensagem || !socket || socket.readyState !== WebSocket.OPEN) {
        console.warn("Não foi possível enviar: socket fechado ou mensagem vazia");
        return;
    }

    socket.send(JSON.stringify({ mensagem }));
    input.value = '';
}

// Event listeners nos contatos
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('#contatos-list a').forEach(link => {
        link.addEventListener('click', async (e) => {
            e.preventDefault();
            const vetId = new URLSearchParams(link.search).get('vet_id');
            if (!vetId) return;

            // Remove destaque de todos
            document.querySelectorAll('#contatos-list a').forEach(el => 
                el.classList.remove('bg-purple-50', 'border-purple-100')
            );
            link.classList.add('bg-purple-50', 'border-purple-100');

            currentVetId = vetId;
            await loadChat(vetId);
        });
    });

    // Intercepta submit inicial (se já tiver form na carga)
    const initialForm = document.querySelector('#chat-area form');
    if (initialForm) {
        initialForm.addEventListener('submit', handleFormSubmit);
    }

    // Conexão inicial se já tiver vet selecionado
    if (currentVetId) {
        connectWebSocket(currentVetId);
        scrollToBottom();
    }
});
</script>
{% endblock %}